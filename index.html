<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Detector de Emociones</title>
<style>
  * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
  }

  body {
    font-family: 'Comic Neue', 'Segoe UI', sans-serif;
    display: flex;
    flex-direction: column;
    align-items: center;
    background: linear-gradient(135deg, #f3f6fc 0%, #e1ebfa 100%);
    min-height: 100vh;
    padding: 15px;
    overflow-x: hidden;
  }

  h1 {
    color: #5a8fd6;
    font-size: 1.8em;
    margin: 10px 0 20px;
    text-align: center;
    text-shadow: 1px 1px 3px rgba(0,0,0,0.1);
  }

  .main-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    width: 100%;
    max-width: 500px;
  }

  /* Contenedor para la carita animada - AHORA ES EL PROTAGONISTA */
  .face-container {
    width: 280px;
    height: 280px;
    position: relative;
    margin: 10px 0 25px;
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 10;
  }

  /* Cara base */
  .face {
    width: 250px;
    height: 300px;
    background-color: #499cc2; /* Azul celeste por defecto */
    border-radius: 40% 40% 20% 20%;
    position: relative;
    box-shadow: 
      0 8px 25px rgba(0,0,0,0.15),
      inset 0 -5px 15px rgba(255,255,255,0.6),
      inset 0 5px 15px rgba(0,0,0,0.1);
    transition: all 0.4s ease;
  }

  /* Colores de emociones para la cara */
  .face.happy {
    background-color: #fff475; /* Amarillo para Alegría */
  }

  .face.sad {
    background-color: #a7c7e7; /* Azul para Tristeza */
  }

  .face.fear {
    background-color: #cba0ff; /* Morado para Miedo */
  }

  .face.angry {
    background-color: #f28b82; /* Rojo para Enojo */
  }

  .face.calm {
    background-color: #81c995; /* Verde para Calma */
  }

  .face.love {
    background-color: #f7a8b8; /* Rosa para Amor */
  }

  .face.frustrated {
    background-color: #f9ab5e; /* Naranja para Frustración */
  }

  .face.excited {
    background-color: #c0c0c0; /* Plateado para Entusiasmo */
  }

  /* Ojos */
  .eye {
    width: 80px;
    height: 80px;
    background-color: white;
    border-radius: 50%;
    position: absolute;
    top: 80px;
    border: 3px solid #333;
    overflow: hidden;
    box-shadow: inset 0 3px 5px rgba(0,0,0,0.1);
    transition: all 0.2s ease;
  }

  .eye.left {
    left: 40px;
  }

  .eye.right {
    right: 40px;
  }

  .pupil {
    width: 28px;
    height: 28px;
    background-color: #333333;
    border-radius: 50%;
    position: absolute;
    top: 23px;
    left: 23px;
    transition: all 0.3s ease;
  }

  .pupil::after {
    content: '';
    width: 8px;
    height: 8px;
    background-color: white;
    border-radius: 50%;
    position: absolute;
    top: 5px;
    left: 5px;
  }

  /* Cejas */
  .eyebrow {
    width: 60px;
    height: 10px;
    background-color: #333;
    border-radius: 5px;
    position: absolute;
    top: 60px;
    transition: all 0.4s ease;
  }

  .eyebrow.left {
    left: 50px;
    transform: rotate(-5deg);
  }

  .eyebrow.right {
    right: 50px;
    transform: rotate(5deg);
  }

  /* Mejillas */
  .cheek {
    width: 40px;
    height: 20px;
    background: radial-gradient(circle, #f7a8b8 0%, rgba(247,168,184,0.5) 70%);
    border-radius: 50%;
    position: absolute;
    top: 180px;
    opacity: 0.8;
  }

  .cheek.left {
    left: 25px;
  }

  .cheek.right {
    right: 25px;
  }

  /* Boca */
  .mouth {
    width: 100px;
    height: 50px;
    position: absolute;
    bottom: 70px;
    left: 75px;
    overflow: hidden;
    transition: all 0.4s ease;
  }

  .mouth-inner {
    width: 100%;
    height: 100%;
    background-color: #333;
    border-radius: 0 0 50px 50px;
    position: relative;
  }

  .tongue {
    width: 60px;
    height: 30px;
    background: radial-gradient(ellipse at center, #ff8fa3 0%, #ff6b8b 100%);
    border-radius: 50%;
    position: absolute;
    bottom: -8px;
    left: 20px;
  }

  /* Estados de emociones */
  
  /* Alegría */
  .face.happy .mouth {
    height: 65px;
    border-radius: 0 0 50px 50px;
  }

  .face.happy .eyebrow {
    top: 55px;
  }

  /* Tristeza */
  .face.sad .mouth {
    height: 25px;
    border-radius: 50px 50px 0 0;
    transform: translateY(15px);
  }

  .face.sad .eyebrow {
    top: 65px;
    transform: rotate(15deg);
  }

  .face.sad .eyebrow.left {
    transform: rotate(-15deg);
  }

  /* Enojo */
  .face.angry .eyebrow {
    top: 55px;
    transform: rotate(-20deg);
  }

  .face.angry .eyebrow.right {
    transform: rotate(20deg);
  }

  .face.angry .mouth {
    height: 30px;
    width: 85px;
    border-radius: 15px;
  }

  /* Calma */
  .face.calm .mouth {
    height: 15px;
    width: 70px;
    border-radius: 15px;
  }

  /* Energía/Entusiasmo */
  .face.excited .mouth {
    height: 75px;
    width: 110px;
  }

  .face.excited .pupil {
    transform: scale(0.8);
  }

  /* Amor/Cariño */
  .face.love .eye {
    transform: scale(0.9);
  }

  .face.love .mouth {
    height: 40px;
    width: 50px;
    border-radius: 50%;
    background-color: #ff6b8b;
  }

  .face.love .mouth-inner {
    display: none;
  }

  /* Miedo */
  .face.fear .eye {
    transform: scale(1.1);
  }

  .face.fear .pupil {
    transform: scale(0.7);
  }

  .face.fear .mouth {
    height: 20px;
    width: 60px;
    border-radius: 50%;
  }

  /* Frustración */
  .face.frustrated .eyebrow {
    top: 65px;
    transform: rotate(10deg);
  }

  .face.frustrated .eyebrow.left {
    transform: rotate(-10deg);
  }

  .face.frustrated .mouth {
    height: 25px;
    width: 70px;
    border-radius: 15px;
  }

  /* Parpadeo de ojos */
  .face.blinking .eye {
    height: 10px;
    border-radius: 5px;
    transition: all 0.1s ease;
  }

  .face.blinking .pupil {
    opacity: 0;
    transition: opacity 0.1s ease;
  }

  /* Indicador de que está hablando */
  .face.speaking .mouth {
    animation: speak 0.5s ease-in-out infinite alternate;
  }

  @keyframes speak {
    0% { transform: scaleY(1); }
    100% { transform: scaleY(1.2); }
  }

  /* Contenedor de la cámara - AHORA ES SECUNDARIO Y MÁS PEQUEÑO */
  .camera-container {
    position: relative;
    width: 100%;
    max-width: 150px; /* REDUCIDO de 300px a 200px */
    margin: 15px 0;
    border-radius: 20px;
    overflow: hidden;
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    opacity: 0.9;
  }

  video {
    width: 100%;
    height: auto;
    display: block;
    transform: scaleX(-1); /* Modo espejo */
  }

  canvas {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
  }

  .detection-circle {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 30%; /* REDUCIDO de 40% a 30% */
    height: 30%; /* REDUCIDO de 40% a 30% */
    border: 3px dashed #5a8fd6;
    border-radius: 50%;
    pointer-events: none;
    transition: all 0.3s ease;
  }

  .detection-circle.disabled {
    border-color: #cccccc;
    opacity: 0.5;
  }

  /* Información de emociones */
  .emotion-display {
    text-align: center;
    padding: 15px;
    width: 100%;
    background: rgba(255, 255, 255, 0.7);
    border-radius: 20px;
    margin: 15px 0;
    box-shadow: 0 4px 10px rgba(0,0,0,0.05);
  }

  .emotion-text {
    font-size: 1.8em;
    font-weight: bold;
    color: #5a8fd6;
    margin-bottom: 8px;
  }

  .emotion-phrase {
    font-size: 1.1em;
    font-style: italic;
    color: #555;
    line-height: 1.4;
  }

  /* Instrucciones */
  .instructions {
    text-align: center;
    margin-top: 10px;
    color: #777;
    font-size: 0.9em;
    padding: 0 10px;
  }

  /* Efectos de animación para la carita */
  @keyframes bounce {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-10px); }
  }

  .face-container {
    animation: bounce 4s ease-in-out infinite;
  }

  /* Responsive para tablets y pantallas más grandes */
  @media (min-width: 768px) {
    .face-container {
      width: 320px;
      height: 320px;
    }
    
    .face {
      width: 280px;
      height: 340px;
    }
    
    h1 {
      font-size: 2.2em;
    }
    
    .emotion-text {
      font-size: 2em;
    }
  }

  /* Efecto de brillo en la carita cuando cambia de emoción */
  .face.changing {
    animation: glow 0.8s ease;
  }

  @keyframes glow {
    0% { box-shadow: 0 8px 25px rgba(0,0,0,0.15); }
    50% { box-shadow: 0 8px 30px rgba(90, 143, 214, 0.4); }
    100% { box-shadow: 0 8px 25px rgba(0,0,0,0.15); }
  }
</style>
</head>
<body>
  <h1>Detector de Emociones</h1>
  
  <div class="main-container">
    <!-- LA CARITA ES AHORA EL PROTAGONISTA -->
    <div class="face-container">
      <div class="face calm" id="animatedFace">
        <div class="eyebrow left"></div>
        <div class="eyebrow right"></div>
        <div class="eye left">
          <div class="pupil"></div>
        </div>
        <div class="eye right">
          <div class="pupil"></div>
        </div>
        <div class="cheek left"></div>
        <div class="cheek right"></div>
        <div class="mouth">
          <div class="mouth-inner">
            <div class="tongue"></div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Información de la emoción detectada -->
    <div class="emotion-display">
      <div class="emotion-text" id="emotionText">Coloca un color en el círculo</div> 
      <div class="emotion-phrase" id="emotionPhrase"></div>
    </div>
    
    <!-- La cámara ahora es secundaria y más pequeña -->
    <div class="camera-container">
      <video id="video" autoplay playsinline muted></video>
      <canvas id="overlayCanvas"></canvas>
      <div class="detection-circle" id="detectionCircle"></div>
    </div>
    
    <div class="instructions">
      Muestra un color dentro del círculo para detectar tu emoción
    </div>
  </div>

<script>
// Emociones y frases adaptadas a niños
// NOTA: La clave 'face' debe coincidir con la clase CSS para la carita
const COLOR_WORD_MAP = {
  yellow: { 
    word: 'Alegría',     
    phrase: 'Cuando sonríes, haces que todo a tu alrededor brille. ¡Tu alegría se contagia como un rayo de sol!', 
    face: 'happy', 
    color: '#fff475' 
  },
  blue: { 
    word: 'Tristeza',   
    phrase: 'A veces nos sentimos tristes, y eso también está bien. Las lágrimas ayudan a limpiar el corazón para volver a sonreír.', 
    face: 'sad', 
    color: '#a7c7e7' 
  },
  purple: { 
    word: 'Miedo',     
    phrase: 'Sentir miedo no te hace débil, te recuerda que estás aprendiendo algo nuevo. ¡Da un paso valiente y verás que puedes!', 
    face: 'fear', 
    color: '#cba0ff' 
  },
  red: { 
    word: 'Enojo',   
    phrase: 'Cuando te enojas, respira profundo y cuenta hasta tres. Así el enojo se transforma en calma y puedes pensar mejor.', 
    face: 'angry', 
    color: '#f28b82' 
  },
  green: { 
    word: 'Calma',       
    phrase: 'Estar en calma te ayuda a pensar, sentirte bien y tomar buenas decisiones. ¡Tu corazón puede ser tan tranquilo como un lago!', 
    face: 'calm', 
    color: '#81c995' 
  },
  pink: { 
    word: 'Amor',  
    phrase: 'Cuando das amor, compartes un pedacito de tu corazón. ¡Cada gesto amable hace el mundo más bonito!', 
    face: 'love', 
    color: '#f7a8b8' 
  },
  orange: { 
    word: 'Frustración',
    phrase: 'Equivocarse no significa que no puedas hacerlo. ¡Cada intento te enseña y te acerca a lograrlo!', 
    face: 'frustrated', 
    color: '#f9ab5e' 
  },
  silver: { 
    word: 'Entusiasmo',  
    phrase: 'Cuando algo te emociona, es porque estás listo para aprender y disfrutar. ¡Aprovecha esa energía para dar lo mejor de ti!', 
    face: 'excited', 
    color: '#c0c0c0' 
  }
};

// Rango de detección en HSV (Actualizados para las nuevas emociones)
const HSV_RANGES = {
  yellow: [ [[20,100,100],[35,255,255]] ],
  blue: [ [[90,50,40],[140,255,255]] ],
  purple: [ [[130,50,50],[160,255,255]] ],
  red: [ [[0,100,50],[10,255,255]], [[160,100,50],[179,255,255]] ],
  green: [ [[35,60,40],[85,255,255]] ],
  pink: [ [[160,30,50],[170,255,255]] ],
  orange: [ [[10,100,100],[25,255,255]] ],
  silver: [ [[0,0,150],[179,30,220]] ] // Rango para plateado
};

let video = document.getElementById('video');
let overlay = document.getElementById('overlayCanvas');
let emotionText = document.getElementById('emotionText');
let emotionPhrase = document.getElementById('emotionPhrase');
let animatedFace = document.getElementById('animatedFace');
let detectionCircle = document.getElementById('detectionCircle');
let stream = null;
let rafId = null;
let lastDetected = null;
let speaking = false;
let blinkInterval = null;
let isBlinking = false;
let detectionEnabled = true;

// -------- FUNCIONES AUXILIARES -------- //
function rgbToHsv(r,g,b){
  r/=255; g/=255; b/=255;
  const mx=Math.max(r,g,b), mn=Math.min(r,g,b), diff=mx-mn;
  let h=0, s=0, v=mx;
  if(diff!==0){
    if(mx===r) h=((g-b)/diff)%6;
    else if(mx===g) h=((b-r)/diff)+2;
    else h=((r-g)/diff)+4;
    h=Math.round(h*60); if(h<0) h+=360;
  }
  s=mx===0?0:diff/mx;
  return [Math.round(h/2), Math.round(s*255), Math.round(v*255)];
}

function inRangeHSV(hsv, low, high){
  const [H,S,V]=hsv;
  return H>=low[0] && H<=high[0] && S>=low[1] && S>=low[1] && V>=low[2] && V<=high[2];
}

function detectColor(imageData, box){
  const {data,width,height}=imageData;
  const x1=Math.max(0,Math.floor(box.x));
  const y1=Math.max(0,Math.floor(box.y));
  const x2=Math.min(width,Math.floor(box.x+box.w));
  const y2=Math.min(height,Math.floor(box.y+box.h));
  const total=(y2-y1)*(x2-x1);
  if(total<=0) return {color:null, ratio:0};
  const counts={}; for(const c in HSV_RANGES) counts[c]=0;
  for(let yy=y1;yy<y2;yy++){
    for(let xx=x1;xx<x2;xx++){
      const idx=(yy*width+xx)*4;
      const r=data[idx], g=data[idx+1], b=data[idx+2];
      const hsv=rgbToHsv(r,g,b);
      for(const [color,ranges] of Object.entries(HSV_RANGES)){
        for(const rng of ranges){
          const [low,high]=rng;
          if(inRangeHSV(hsv,low,high)){ counts[color]++; break; }
        }
      }
    }
  }
  let best=null, ratio=0;
  for(const [c,count] of Object.entries(counts)){
    const r=count/total;
    if(r>ratio){ ratio=r; best=c; }
  }
  return ratio>=0.25 ? {color:best, ratio} : {color:null, ratio};
}

// -------- PARPADEO DE OJOS -------- //
function startBlinking() {
  if (isBlinking) return;
  
  isBlinking = true;
  blinkInterval = setInterval(() => {
    // Añadir clase de parpadeo
    animatedFace.classList.add('blinking');
    
    // Quitar clase de parpadeo después de un tiempo corto
    setTimeout(() => {
      animatedFace.classList.remove('blinking');
    }, 100);
  }, 3000); // Parpadea cada 3 segundos
}

function stopBlinking() {
  if (!isBlinking) return;
  
  isBlinking = false;
  clearInterval(blinkInterval);
  animatedFace.classList.remove('blinking');
}

// -------- CONTROL DE DETECCIÓN -------- //
function enableDetection() {
  detectionEnabled = true;
  detectionCircle.classList.remove('disabled');
}

function disableDetection() {
  detectionEnabled = false;
  detectionCircle.classList.add('disabled');
}

// -------- VOZ INFANTIL -------- //
function getFriendlyVoice() {
  const voices = window.speechSynthesis.getVoices();
  return voices.find(v =>
    v.lang.startsWith('es') &&
    (v.name.toLowerCase().includes('google') ||
     v.name.toLowerCase().includes('paulina') ||
     v.name.toLowerCase().includes('sabina') ||
     v.name.toLowerCase().includes('child'))
  ) || voices.find(v => v.lang.startsWith('es')) || voices[0];
}

function speakPhrase(text){
  if(!text || speaking) return;
  
  // Deshabilitar detección mientras habla
  disableDetection();
  speaking = true;
  
  // Añadir animación de habla
  animatedFace.classList.add('speaking');
  
  const utter = new SpeechSynthesisUtterance(text);
  utter.voice = getFriendlyVoice();
  utter.lang = 'es-ES';
  utter.pitch = 1.6;
  utter.rate = 1.15;
  utter.volume = 1.0;
  
  utter.onend = ()=>{
    speaking = false;
    // Quitar animación de habla
    animatedFace.classList.remove('speaking');
    // Habilitar detección nuevamente
    enableDetection();
  };
  
  utter.onerror = ()=>{
    speaking = false;
    // Quitar animación de habla
    animatedFace.classList.remove('speaking');
    // Habilitar detección nuevamente
    enableDetection();
  };
  
  window.speechSynthesis.speak(utter);
}

// -------- CÁMARA -------- //
async function startCamera(){
  try{
    // Para móviles, usamos la cámara trasera si está disponible
    const constraints = {
      video: {
        facingMode: 'user', // Preferir cámara trasera
        width: { ideal: 640 },
        height: { ideal: 480 }
      }
    };
    
    stream = await navigator.mediaDevices.getUserMedia(constraints);
    video.srcObject = stream;
    
    await new Promise(resolve => {
      video.onloadedmetadata = resolve;
    });
    
    overlay.width = video.videoWidth;
    overlay.height = video.videoHeight;
    loop();
  } catch(err) { 
    console.error("Error al acceder a la cámara:", err);
    // Fallback a cámara frontal si la trasera no está disponible
    try {
      const constraints = { video: true };
      stream = await navigator.mediaDevices.getUserMedia(constraints);
      video.srcObject = stream;
      
      await new Promise(resolve => {
        video.onloadedmetadata = resolve;
      });
      
      overlay.width = video.videoWidth;
      overlay.height = video.videoHeight;
      loop();
    } catch(fallbackErr) {
      console.error("Error con cámara frontal:", fallbackErr);
      alert("No se pudo acceder a la cámara. Asegúrate de permitir el acceso.");
    }
  }
}

function stopCamera(){
  if(stream){ 
    stream.getTracks().forEach(track => track.stop()); 
    stream=null; 
  }
  if(rafId) cancelAnimationFrame(rafId);
  if(blinkInterval) clearInterval(blinkInterval);
}

// -------- LOOP PRINCIPAL -------- //
function loop(){
  const ctx = overlay.getContext('2d');
  const tmp = document.createElement('canvas');
  tmp.width = video.videoWidth;
  tmp.height = video.videoHeight;
  const tctx = tmp.getContext('2d');

  function frame(){
    if(!stream) return;
    tctx.drawImage(video, 0, 0, tmp.width, tmp.height);
    
    // Define el área de detección (caja central REDUCIDA al 25% para mayor sensibilidad)
    const box_w = tmp.width * 0.25; // REDUCIDO de 0.4 a 0.25
    const box_h = tmp.height * 0.25; // REDUCIDO de 0.4 a 0.25
    const box_x = (tmp.width - box_w) / 2;
    const box_y = (tmp.height - box_h) / 2;
    const box = {x: box_x, y: box_y, w: box_w, h: box_h};
    
    const imageData = tctx.getImageData(0, 0, tmp.width, tmp.height);
    const detected = detectColor(imageData, box);
    
    const W = ctx.canvas.width;
    const H = ctx.canvas.height;
    const cx = W / 2;
    const cy = H / 2;
    const radius = Math.min(W, H) * 0.15; // Círculo REDUCIDO de 0.2 a 0.15

    ctx.clearRect(0, 0, W, H);
    
    // Dibuja el círculo de detección en el canvas
    ctx.beginPath();
    ctx.arc(cx, cy, radius, 0, 2 * Math.PI);
    ctx.lineWidth = 4;
    ctx.strokeStyle = detected.color && detectionEnabled ? COLOR_WORD_MAP[detected.color].color : '#5a8fd6';
    ctx.stroke();

    // Solo procesar detección si está habilitada y no está hablando
    if (detectionEnabled && !speaking) {
      // Lógica para cambiar la carita animada y el texto
      if(detected.color && detected.color !== lastDetected){
        // Cambio de emoción detectado
        lastDetected = detected.color;
        const emo = COLOR_WORD_MAP[detected.color];
        
        // 1. Detener el parpadeo
        stopBlinking();
        
        // 2. Añadir efecto de cambio
        animatedFace.classList.add('changing');
        setTimeout(() => {
          animatedFace.classList.remove('changing');
        }, 800);
        
        // 3. Actualiza la carita animada con el color correspondiente
        animatedFace.className = 'face';
        animatedFace.classList.add(emo.face);
        
        // 4. Actualiza el texto
        emotionText.textContent = emo.word;
        emotionPhrase.textContent = emo.phrase;
        
        // 5. Habla la frase
        speakPhrase(emo.phrase);
      } 
      
      // Si no se detecta color, vuelve a un estado neutral y empieza a parpadear
      if (!detected.color) {
        if (lastDetected !== 'calm') {
          lastDetected = 'calm';
          animatedFace.className = 'face calm';
          emotionText.textContent = 'Coloca un color en el círculo';
          emotionPhrase.textContent = '';
        }
        
        // Iniciar parpadeo si no está activo
        if (!isBlinking) {
          startBlinking();
        }
      } else {
        // Si se detecta color, detener el parpadeo
        stopBlinking();
      }
    }

    rafId = requestAnimationFrame(frame);
  }
  frame();
}

// -------- INICIALIZACIÓN -------- //
window.addEventListener('load', startCamera);
window.addEventListener('beforeunload', stopCamera);

// Para iOS - necesita un gesto de usuario para reproducir audio
document.addEventListener('touchstart', function() {
  // Solo necesitamos un gesto del usuario para habilitar audio
}, { once: true });
</script>
</body>
</html>
